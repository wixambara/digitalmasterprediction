<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wix Ambara's Blog Post</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Lora:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; /* Notion-like light gray background */
        }
        #article-content {
            font-family: 'Lora', serif; /* A nice serif font for reading */
        }
        .prediction-value {
            font-weight: 700; /* Bolds the prediction */
            color: #1e293b;   /* Slightly darker text */
        }
    </style>
</head>
<body class="text-gray-800 antialiased">

    <div id="app" class="relative min-h-screen w-full">
        
        <!-- Header -->
        <header id="page-header" class="bg-white/80 backdrop-blur-md sticky top-0 z-10 border-b border-gray-200">
            <div class="max-w-3xl mx-auto px-6 sm:px-8">
                <div class="flex justify-between items-center py-4">
                    <a href="#" class="text-lg font-bold text-gray-900">Wix Ambara's Blog Post</a>
                    <nav class="hidden md:flex space-x-6">
                        <a href="#" class="text-gray-600">Home</a>
                        <a href="#" class="text-gray-600">About</a>
                        <a href="#" class="text-gray-600">Contact</a>
                    </nav>
                </div>
            </div>
        </header>

        <!-- Loader -->
        <div id="loader" class="flex items-center justify-center h-[calc(100vh-200px)]">
            <svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>

        <!-- Article View -->
        <main id="article-container" class="hidden max-w-3xl mx-auto px-6 py-12 sm:px-8 sm:py-16">
            <article>
                <h1 id="article-title" class="text-3xl md:text-4xl font-bold text-gray-900 leading-tight mb-3"></h1>
                <p id="article-date" class="text-gray-500 mb-8"></p>
                <div id="article-content" class="text-lg md:text-xl text-gray-800 leading-relaxed space-y-6">
                    <!-- Transformed article content will be injected here -->
                </div>
            </article>
        </main>

        <!-- Footer -->
        <footer id="footer" class="hidden border-t border-gray-200 mt-16">
            <div class="max-w-3xl mx-auto px-6 sm:px-8 py-8 text-center text-gray-500 text-sm">
                <p id="copyright-text"></p>
            </div>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCd13i8nOby99JTa2AyhsG_YuFLmj5Bt5s",
            authDomain: "digital-master-prediction.firebaseapp.com",
            projectId: "digital-master-prediction",
            storageBucket: "digital-master-prediction.firebasestorage.app",
            messagingSenderId: "671010231911",
            appId: "1:671010231911:web:1d49fc7aff2cc3b09566c2"
        };
        
        let app, auth, db;
        const FIXED_USER_ID = "wixAmbara";
        const LOCAL_STORAGE_KEY = 'dmp_viewer_data';

        const DOM = {
            loader: document.getElementById('loader'),
            header: document.getElementById('page-header'),
            articleContainer: document.getElementById('article-container'),
            footer: document.getElementById('footer'),
            copyrightText: document.getElementById('copyright-text'),
            articleTitle: document.getElementById('article-title'),
            articleDate: document.getElementById('article-date'),
            articleContent: document.getElementById('article-content'),
        };

        function renderArticle(data) {
            const showContent = () => {
                DOM.loader.classList.add('hidden');
                DOM.articleContainer.classList.remove('hidden');
                DOM.footer.classList.remove('hidden');
            };
            
            DOM.copyrightText.textContent = `Â© ${new Date().getFullYear()} Wix Ambara. All rights reserved.`;

            if (!data || !data.config) {
                DOM.articleTitle.textContent = "Artikel tidak ditemukan";
                DOM.articleContent.textContent = "Silakan atur konten melalui halaman kontrol terlebih dahulu.";
                showContent();
                return;
            }

            const { config, predictions } = data;

            // Set Title and Date
            DOM.articleTitle.textContent = config.title || "Tanpa Judul";
            try {
                 DOM.articleDate.textContent = new Date(config.date).toLocaleDateString('id-ID', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });
            } catch (e) {
                DOM.articleDate.textContent = config.date || "";
            }

            // Transform Content
            let content = config.content || "";
            const finalPredictions = predictions || {};

            const placeholders = [...new Set((content.match(/\$(\w+)/g) || []))];

            placeholders.forEach(placeholderKey => {
                const key = placeholderKey.substring(1);
                const value = finalPredictions[key] || '_____';
                
                const capitalizedValue = value.charAt(0).toUpperCase() + value.slice(1);

                const replacementHtml = `<strong class="prediction-value">${capitalizedValue}</strong>`;
                content = content.replace(new RegExp(`\\${placeholderKey}`, 'g'), replacementHtml);
            });
            
            DOM.articleContent.innerHTML = content.split('\n').filter(p => p.trim() !== '').map(p => `<p>${p}</p>`).join('');

            showContent();
        }
        
        async function init() {
            // 1. Try to load from local storage first
            const localDataRaw = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (localDataRaw) {
                try {
                    const localData = JSON.parse(localDataRaw);
                    renderArticle(localData);
                } catch (e) {
                    console.error("Failed to parse local data", e);
                }
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await signInAnonymously(auth);
                
                const docRef = doc(db, "artifacts", FIXED_USER_ID);
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const serverData = docSnap.data();
                        renderArticle(serverData);
                        // 2. Automatically save fresh data to local storage
                        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(serverData));
                    } else {
                        renderArticle(null);
                        localStorage.removeItem(LOCAL_STORAGE_KEY);
                    }
                }, (error) => {
                    console.error("Error listening to Firestore:", error);
                    if (!localDataRaw) renderArticle(null); // Only show error if no local data
                });

            } catch (error) {
                console.error("Firebase Init Error:", error);
                if (!localDataRaw) renderArticle(null); // Only show error if no local data
            }

            // 3. Add triple click reset feature
            let tapCount = 0;
            let lastTapTime = 0;
            DOM.header.addEventListener('click', () => {
                const currentTime = new Date().getTime();
                if (currentTime - lastTapTime < 300) { // 300ms window for triple tap
                    tapCount++;
                } else {
                    tapCount = 1;
                }
                lastTapTime = currentTime;

                if (tapCount === 3) {
                    localStorage.removeItem(LOCAL_STORAGE_KEY);
                    window.location.replace('https://google.com/');
                }
            });
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
